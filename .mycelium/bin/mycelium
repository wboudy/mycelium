#!/usr/bin/env bash
# mycelium - CLI for agent workflow automation
# Usage: mycelium <command> [options]
#
# Subcommands:
#   next    Generate and copy the agent prompt for the current mission agent
#   list    List all missions with status
#   agents  List all agents with frontmatter metadata
#   status  Show detailed status of a mission

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

usage() {
    echo "Usage: mycelium <command> [options]"
    echo ""
    echo "Commands:"
    echo "  next [mission-path]    Generate agent prompt for the next agent"
    echo "  list                   List all missions with status"
    echo "  agents                 List all agents with frontmatter metadata"
    echo "  status <mission-path>  Show detailed status of a mission"
    echo ""
    echo "Examples:"
    echo "  .mycelium/bin/mycelium next .mycelium/missions/my-mission"
    echo "  .mycelium/bin/mycelium list"
    echo "  .mycelium/bin/mycelium agents"
    echo "  .mycelium/bin/mycelium status .mycelium/missions/my-mission"
}

# Extract current_agent from progress.yaml using grep/sed (portable approach)
extract_current_agent() {
    local progress_file="$1"
    
    # Use grep to find the current_agent line and sed to extract the value
    # Handles: current_agent: "value", current_agent: 'value', current_agent: value
    local agent_line
    agent_line=$(grep -E "^current_agent:" "$progress_file" 2>/dev/null || echo "")
    
    if [[ -z "$agent_line" ]]; then
        echo ""
        return
    fi
    
    # Extract value after the colon, strip quotes and whitespace
    local value
    value=$(echo "$agent_line" | sed 's/^current_agent:[[:space:]]*//' | sed 's/^["'"'"']//' | sed 's/["'"'"']$//' | tr -d '[:space:]')
    echo "$value"
}

# Copy to clipboard (cross-platform)
copy_to_clipboard() {
    local text="$1"
    
    if command -v pbcopy &>/dev/null; then
        # macOS
        echo -n "$text" | pbcopy
        return 0
    elif command -v xclip &>/dev/null; then
        # Linux with xclip
        echo -n "$text" | xclip -selection clipboard
        return 0
    elif command -v xsel &>/dev/null; then
        # Linux with xsel
        echo -n "$text" | xsel --clipboard --input
        return 0
    else
        return 1
    fi
}

# Find the repo root (where .mycelium directory exists)
find_repo_root() {
    local dir="$PWD"
    while [[ "$dir" != "/" ]]; do
        if [[ -d "$dir/.mycelium" ]]; then
            echo "$dir"
            return 0
        fi
        dir=$(dirname "$dir")
    done
    return 1
}

# Extract YAML frontmatter value from a markdown file
extract_frontmatter_value() {
    local file="$1"
    local key="$2"
    
    # Extract frontmatter between --- delimiters and find the key
    sed -n '/^---$/,/^---$/p' "$file" 2>/dev/null | grep -E "^${key}:" | head -1 | sed "s/^${key}:[[:space:]]*//" | sed 's/^["'"'"']//' | sed 's/["'"'"']$//' | sed 's/#.*//' | tr -d '[:space:]'
}

# ============================================================================
# cmd_list - List all missions with status
# ============================================================================
cmd_list() {
    local repo_root
    repo_root=$(find_repo_root) || {
        echo -e "${RED}Error: Not in a mycelium repository${NC}" >&2
        exit 1
    }
    
    local missions_dir="$repo_root/.mycelium/missions"
    
    if [[ ! -d "$missions_dir" ]]; then
        echo -e "${YELLOW}No missions found${NC}"
        exit 0
    fi
    
    echo -e "${CYAN}Missions${NC}"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    printf "%-30s %-15s %s\n" "MISSION" "AGENT" "STATUS"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    
    local found_any=false
    for progress_file in "$missions_dir"/*/progress.yaml; do
        [[ -f "$progress_file" ]] || continue
        found_any=true
        
        local mission_name
        mission_name=$(basename "$(dirname "$progress_file")")
        
        local current_agent
        current_agent=$(extract_current_agent "$progress_file")
        
        local status_emoji status_text
        if [[ -z "$current_agent" ]]; then
            status_emoji="âœ…"
            status_text="Done"
            current_agent="(complete)"
        else
            # Check if file is stalled (not modified in 3+ days)
            local mtime_days=0
            if command -v stat &>/dev/null; then
                if [[ "$(uname)" == "Darwin" ]]; then
                    mtime_days=$(( ($(date +%s) - $(stat -f %m "$progress_file")) / 86400 ))
                else
                    mtime_days=$(( ($(date +%s) - $(stat -c %Y "$progress_file")) / 86400 ))
                fi
            fi
            
            if [[ $mtime_days -ge 3 ]]; then
                status_emoji="â¸ï¸"
                status_text="Stalled (${mtime_days}d)"
            else
                status_emoji="ðŸ”µ"
                status_text="Active"
            fi
        fi
        
        printf "%-30s %-15s %s %s\n" "$mission_name" "$current_agent" "$status_emoji" "$status_text"
    done
    
    if [[ "$found_any" == "false" ]]; then
        echo "  No missions found"
    fi
    
    echo ""
}

# ============================================================================
# cmd_agents - List all agents with frontmatter metadata
# ============================================================================
cmd_agents() {
    local repo_root
    repo_root=$(find_repo_root) || {
        echo -e "${RED}Error: Not in a mycelium repository${NC}" >&2
        exit 1
    }
    
    echo -e "${CYAN}Agents${NC}"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    printf "%-20s %-15s %s\n" "ROLE" "MAY EDIT CODE" "SEQUENCES TO"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    
    # Process mission agents
    for agent_file in "$repo_root"/.mycelium/agents/mission/*.md; do
        [[ -f "$agent_file" ]] || continue
        
        local role may_edit sequences_to
        role=$(extract_frontmatter_value "$agent_file" "role")
        may_edit=$(extract_frontmatter_value "$agent_file" "may_edit_code")
        sequences_to=$(extract_frontmatter_value "$agent_file" "self_sequence_to")
        
        # Format may_edit_code as emoji
        local edit_emoji
        if [[ "$may_edit" == "true" ]]; then
            edit_emoji="âœ… Yes"
        else
            edit_emoji="âŒ No"
        fi
        
        # Handle empty/null sequences_to
        if [[ -z "$sequences_to" || "$sequences_to" == "null" ]]; then
            sequences_to="(none)"
        fi
        
        printf "%-20s %-15s %s\n" "$role" "$edit_emoji" "$sequences_to"
    done
    
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    echo -e "${YELLOW}Standalone Agents${NC}"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    
    # Process standalone agents
    for agent_file in "$repo_root"/.mycelium/agents/standalone/*.md; do
        [[ -f "$agent_file" ]] || continue
        
        local role may_edit sequences_to
        role=$(extract_frontmatter_value "$agent_file" "role")
        may_edit=$(extract_frontmatter_value "$agent_file" "may_edit_code")
        sequences_to=$(extract_frontmatter_value "$agent_file" "self_sequence_to")
        
        # Format may_edit_code as emoji
        local edit_emoji
        if [[ "$may_edit" == "true" ]]; then
            edit_emoji="âœ… Yes"
        else
            edit_emoji="âŒ No"
        fi
        
        # Handle empty/null sequences_to
        if [[ -z "$sequences_to" || "$sequences_to" == "null" ]]; then
            sequences_to="(standalone)"
        fi
        
        printf "%-20s %-15s %s\n" "$role" "$edit_emoji" "$sequences_to"
    done
    
    echo ""
}

# ============================================================================
# cmd_status - Show detailed status of a mission
# ============================================================================
cmd_status() {
    local mission_path="${1:-}"
    local progress_file=""
    
    # Determine progress.yaml location
    if [[ -n "$mission_path" ]]; then
        if [[ "$mission_path" == *.yaml ]]; then
            progress_file="$mission_path"
        elif [[ -d "$mission_path" ]]; then
            progress_file="$mission_path/progress.yaml"
        else
            echo -e "${RED}Error: Path does not exist: $mission_path${NC}" >&2
            exit 1
        fi
    else
        if [[ -f "progress.yaml" ]]; then
            progress_file="progress.yaml"
        else
            echo -e "${RED}Error: No mission path provided${NC}" >&2
            echo "Usage: mycelium status <mission-path>" >&2
            exit 1
        fi
    fi
    
    if [[ ! -f "$progress_file" ]]; then
        echo -e "${RED}Error: progress.yaml not found at: $progress_file${NC}" >&2
        exit 1
    fi
    
    local mission_name
    mission_name=$(basename "$(dirname "$progress_file")")
    
    local current_agent
    current_agent=$(extract_current_agent "$progress_file")
    
    # Count DoD items
    local dod_total=0
    local dod_done=0
    while IFS= read -r line; do
        if [[ "$line" =~ status:[[:space:]]*\"?pending\"? ]]; then
            ((dod_total++)) || true
        elif [[ "$line" =~ status:[[:space:]]*\"?done\"? ]]; then
            ((dod_total++)) || true
            ((dod_done++)) || true
        elif [[ "$line" =~ status:[[:space:]]*\"?PASS\"? ]]; then
            ((dod_total++)) || true
            ((dod_done++)) || true
        fi
    done < <(grep -A1 "description:" "$progress_file" 2>/dev/null | grep "status:" || true)
    
    # Get objective
    local objective
    objective=$(grep -A1 "^  objective:" "$progress_file" 2>/dev/null | head -1 | sed 's/^  objective:[[:space:]]*//' | sed 's/^"//' | sed 's/"$//')
    
    # Get last iteration info
    local last_iteration=""
    local last_changes=""
    if grep -q "implementer_log:" "$progress_file"; then
        last_iteration=$(grep -E "^  - iteration:" "$progress_file" | tail -1 | sed 's/.*iteration:[[:space:]]*//')
    fi
    
    # Display status
    echo ""
    echo -e "${CYAN}Mission: ${NC}${YELLOW}$mission_name${NC}"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    
    if [[ -z "$current_agent" ]]; then
        echo -e "Agent:      ${GREEN}(complete)${NC} âœ…"
    else
        echo -e "Agent:      ${BLUE}$current_agent${NC} ðŸ”µ"
    fi
    
    if [[ $dod_total -gt 0 ]]; then
        local progress_pct=$((dod_done * 100 / dod_total))
        echo -e "DoD:        $dod_done/$dod_total items ($progress_pct%)"
    else
        echo "DoD:        (not defined yet)"
    fi
    
    if [[ -n "$last_iteration" ]]; then
        echo -e "Iteration:  $last_iteration"
    fi
    
    if [[ -n "$objective" ]]; then
        echo ""
        echo -e "${CYAN}Objective:${NC}"
        echo "  $objective"
    fi
    
    echo ""
}

# ============================================================================
# cmd_next - Generate agent prompt (existing functionality)
# ============================================================================
cmd_next() {
    local mission_path="${1:-}"
    local progress_file=""
    local mission_dir=""
    
    # Determine progress.yaml location
    if [[ -n "$mission_path" ]]; then
        if [[ "$mission_path" == *.yaml ]]; then
            progress_file="$mission_path"
            mission_dir=$(dirname "$progress_file")
        elif [[ -d "$mission_path" ]]; then
            mission_dir="$mission_path"
            progress_file="$mission_path/progress.yaml"
        else
            echo -e "${RED}Error: Path does not exist: $mission_path${NC}" >&2
            exit 1
        fi
    else
        # Try to find progress.yaml in current directory or parent mission dirs
        if [[ -f "progress.yaml" ]]; then
            progress_file="progress.yaml"
            mission_dir="."
        else
            echo -e "${RED}Error: No mission path provided and no progress.yaml in current directory${NC}" >&2
            echo "Usage: mycelium next [mission-path]" >&2
            exit 1
        fi
    fi
    
    # Verify progress.yaml exists
    if [[ ! -f "$progress_file" ]]; then
        echo -e "${RED}Error: progress.yaml not found at: $progress_file${NC}" >&2
        exit 1
    fi
    
    # Extract current_agent
    local current_agent
    current_agent=$(extract_current_agent "$progress_file")
    
    # Handle empty (mission complete)
    if [[ -z "$current_agent" ]]; then
        echo -e "${GREEN}âœ… Mission complete${NC}"
        echo "No agent to run â€” current_agent is empty."
        exit 0
    fi
    
    # Validate agent name
    case "$current_agent" in
        scientist|implementer|verifier|maintainer)
            ;;
        *)
            echo -e "${RED}Error: Invalid current_agent value: '$current_agent'${NC}" >&2
            echo "Valid values: scientist, implementer, verifier, maintainer, or empty" >&2
            exit 1
            ;;
    esac
    
    # Construct the prompt
    local prompt
    prompt="Please follow:
- \`ai-team/CONTRACT.md\`
- \`ai-team/agents/mission/${current_agent}.md\`

INPUTS:
- Progress Artifact: \`${progress_file}\`"
    
    # Print to stdout
    echo -e "${YELLOW}=== Agent Prompt (${current_agent}) ===${NC}"
    echo ""
    echo "$prompt"
    echo ""
    
    # Copy to clipboard
    if copy_to_clipboard "$prompt"; then
        echo -e "${GREEN}âœ… Copied to clipboard${NC}"
    else
        echo -e "${YELLOW}âš ï¸  Could not copy to clipboard (pbcopy/xclip/xsel not found)${NC}"
    fi
}

# Main entry point
main() {
    if [[ $# -eq 0 ]]; then
        usage
        exit 1
    fi
    
    local command="$1"
    shift
    
    case "$command" in
        next)
            cmd_next "$@"
            ;;
        list)
            cmd_list "$@"
            ;;
        agents)
            cmd_agents "$@"
            ;;
        status)
            cmd_status "$@"
            ;;
        -h|--help|help)
            usage
            ;;
        *)
            echo -e "${RED}Unknown command: $command${NC}" >&2
            usage
            exit 1
            ;;
    esac
}

main "$@"

